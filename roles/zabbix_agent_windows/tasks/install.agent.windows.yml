---

- name: "Windows | Set path to zabbix.exe"
  set_fact:
    zabbix_win_exe_path: '{{ zabbix_win_install_dir }}\bin\zabbix_agent2.exe'

- name:  Criando estrutura Diretorio
  win_file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ zabbix_win_install_dir }}"


- name: Download Zabbix Agent Zip file
  win_get_url:
    url: "{{zabbix_win_download_link }}"
    dest: '{{ zabbix_win_install_dir }}'
    force: False
    follow_redirects: all

- name: "Windows | Unzip file"
  win_unzip:
    src: '{{ zabbix_win_install_dir }}\{{ zabbix_win_package }}'
    dest: "{{ zabbix_win_install_dir }}"
    creates: '{{ zabbix_win_exe_path }}'

- name: "Windows | Register Service"
  win_command: '{{ zabbix_win_exe_path }} --config {{ zabbix_win_install_dir }}\conf\zabbix_agent2.conf --install'
  register: zabbix_windows_install
  ignore_errors: yes

- name: Configurações o Arquivo zabbix_agentd.conf
  win_lineinfile:
    dest: '{{ zabbix_win_install_dir }}\conf\zabbix_agent2.conf'
    state: present
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backrefs: yes
  loop:
    - { regexp: "^Server=127.0.0.1", line: "Server={{ zbx_proxy }}" }
    - { regexp: "^ServerActive=127.0.0.1", line: "ServerActive={{ zbx_proxy }} " }
    - { regexp: "^Hostname=Windows host", line: "Hostname={{ ansible_hostname }}" }
    - { regexp: "# Timeout=3", line: "Timeout=30" }
    - { regexp: "# DenyKey=system.run[*]", line: "AllowKey=system.run[*]" }

- name: Restart o service
  win_service:
    name: Zabbix Agent 2
    start_mode: auto
    state: started
  ignore_errors: yes

- name: "Windows | Add Porta Zabbix Firewall rule "
  win_firewall_rule:
    name: Zabbix Agent
    localport: 10050
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: yes
  ignore_errors: yes

...